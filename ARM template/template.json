{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "String",
            "metadata": {
                "description": "The name of the Administrator of the new VMs and Domain"
            }
        },
        "adminPassword": {
            "type": "SecureString",
            "metadata": {
                "description": "The password for the Administrator account of the new VMs and Domain"
            }
        },
        "adVMSize": {
            "defaultValue": "Standard_B1s",
            "allowedValues": [
                "Standard_B1s"
            ],
            "type": "String",
            "metadata": {
                "description": "The size of the SQL VMs Created"
            }
        },
        "sqlVMSize": {
            "defaultValue": "Standard_B2s",
            "allowedValues": [
                "Standard_B2s"
            ],
            "type": "String",
            "metadata": {
                "description": "The size of the SQL VMs Created"
            }
        },
        "witnessVMSize": {
            "defaultValue": "Standard_B1s",
            "allowedValues": [
                "Standard_B1s"
            ],
            "type": "String",
            "metadata": {
                "description": "The size of the Witness VM Created"
            }
        },
        "domainName": {
            "defaultValue": "contoso.local",
            "type": "String",
            "metadata": {
                "description": "The FQDN of the AD Domain created "
            }
        },
        "sqlServerServiceAccountUserName": {
            "defaultValue": "sqlservice",
            "type": "String",
            "metadata": {
                "description": "The SQL Server Service Account name"
            }
        },
        "sqlServerServiceAccountPassword": {
            "type": "SecureString",
            "metadata": {
                "description": "The SQL Server Service Account password"
            }
        },
        "sqlStorageAccountName": {
            "type": "String",
            "metadata": {
                "description": "The name of Sql Server Storage Account"
            }
        },
        "sqlStorageAccountType": {
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS"
            ],
            "type": "String",
            "metadata": {
                "description": "The type of the Sql Server Storage Account created"
            }
        },
        "dcStorageAccountName": {
            "type": "String",
            "metadata": {
                "description": "The name of  DC Storage Account"
            }
        },
        "dcStorageAccountType": {
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "type": "String",
            "metadata": {
                "description": "The type of the DC Storage Account created"
            }
        },
        "virtualNetworkAddressRange": {
            "defaultValue": "10.0.0.0/16",
            "type": "String",
            "metadata": {
                "description": "The address range of the new VNET in CIDR format"
            }
        },
        "staticSubnet": {
            "defaultValue": "10.0.0.0/24",
            "type": "String",
            "metadata": {
                "description": "The address range of the subnet static IPs are allocated from in the new VNET"
            }
        },
        "sqlSubnet": {
            "defaultValue": "10.0.1.0/26",
            "type": "String",
            "metadata": {
                "description": "The address range of the SQL subnet created in the new VNET"
            }
        },
        "adPDCNICIPAddress": {
            "defaultValue": "10.0.0.4",
            "type": "String",
            "metadata": {
                "description": "The IP address of the new AD VM"
            }
        },
        "adBDCNICIPAddress": {
            "defaultValue": "10.0.0.5",
            "type": "String",
            "metadata": {
                "description": "The IP address of the new backup AD VM"
            }
        },
        "sqlLBIPAddress": {
            "defaultValue": "10.0.1.9",
            "type": "String",
            "metadata": {
                "description": "The IP address of the new SQL Server Internal Load Balancer"
            }
        },
        "deploymentPrefix": {
            "defaultValue": "aodns",
            "type": "String",
            "metadata": {
                "description": "The DNS Prefix for the Public IP Address for the Always On Cluster"
            }
        },
        "virtualNetworkName": {
            "defaultValue": "autohav2VNET",
            "type": "String",
            "metadata": {
                "description": "Name of virtual network to be created"
            }
        },
        "templatesBaseUrl": {
            "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/sqlvm-alwayson-cluster/nested",
            "type": "String",
            "metadata": {
                "description": "Linked Templates base url"
            }
        },
        "scriptsBaseUrl": {
            "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/sqlvm-alwayson-cluster/scripts",
            "type": "String",
            "metadata": {
                "description": "DSC Scripts base url"
            }
        },
        "autoPatchingDay": {
            "defaultValue": "Sunday",
            "allowedValues": [
                "Never",
                "Everyday",
                "Sunday",
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday"
            ],
            "type": "String",
            "metadata": {
                "description": "The day of a week for auto patching"
            }
        },
        "autoPatchingStartHour": {
            "defaultValue": "2",
            "allowedValues": [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
                "10",
                "11",
                "12",
                "13",
                "14",
                "15",
                "16",
                "17",
                "18",
                "19",
                "20",
                "21",
                "22",
                "23"
            ],
            "type": "String",
            "metadata": {
                "description": "The start hour of a day for auto patching"
            }
        },
        "sqlAOAGName": {
            "defaultValue": "alwayson-ag",
            "type": "String",
            "metadata": {
                "description": "The Sql AlwaysOn Group Name"
            }
        },
        "sqlAOListenerPort": {
            "defaultValue": "1433",
            "type": "String",
            "metadata": {
                "description": "The Sql AG Listener port"
            }
        },
        "sqlAOListenerName": {
            "defaultValue": "alwayson-ag-listener",
            "type": "String",
            "metadata": {
                "description": "The Sql AG Listener Name"
            }
        },
        "sqlServerVersion": {
            "defaultValue": "SQL2014SP2-WS2012R2",
            "allowedValues": [
                "SQL2014SP2-WS2012R2"
            ],
            "type": "String",
            "metadata": {
                "description": "The Sql Server Version"
            }
        },
        "numberOfSqlVMDisks": {
            "defaultValue": "2",
            "allowedValues": [
                "1",
                "2",
                "3",
                "4"
            ],
            "type": "String",
            "metadata": {
                "description": "The Sql VM Disk Size"
            }
        },
        "workloadType": {
            "defaultValue": "GENERAL",
            "allowedValues": [
                "GENERAL",
                "OLTP",
                "DW"
            ],
            "type": "String",
            "metadata": {
                "description": "The Sql VM work load type: GENERAL - general work load; DW - datawear house work load; OLTP - Transactional processing work load"
            }
        },
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "type": "String",
            "metadata": {
                "description": "Location for all resources."
            }
        }
    },
    "variables": {
        "lbSettings": {
            "rdpLBFE": "rdpLBFE",
            "sqlLBFE": "sqlLBFE",
            "adLBBE": "adLBBE",
            "sqlLBBE": "sqlLBBE",
            "rdpLBName": "rdpLoadBalancer",
            "sqlLBName": "sqlLoadBalancer"
        },
        "subnetNames": {
            "staticSubnetName": "staticSubnet",
            "sqlSubnetName": "sqlSubnet"
        },
        "RDPNAT": "RDP",
        "SQLAOProbe": "SQLAlwaysOnEndPointProbe",
        "primaryDCIPAddressName": "primaryDCIP",
        "backupDCIPAddressName": "backupDCIP",
        "sql1AddressName": "sql1IP",
        "sql0AddressName": "sql0IP",
        "vmSettings": {
            "availabilitySets": {
                "sqlAvailabilitySetName": "sqlAvailabilitySet",
                "adAvailabilitySetName": "adAvailabilitySet"
            },
            "noOfSqlVMs": 2,
            "vmContainerName": "vhds",
            "adPDCVMName": "ad-primary-dc",
            "adBDCVMName": "ad-secondary-dc",
            "sqlVMName": "sqlserver-",
            "sqlwVMName": "cluster-fsw",
            "windowsImagePublisher": "MicrosoftWindowsServer",
            "windowsImageOffer": "WindowsServer",
            "windowsImageSKU": "2012-R2-Datacenter",
            "sqlImagePublisher": "MicrosoftSQLServer",
            "sqlImageOffer": "[parameters('sqlServerVersion')]",
            "rdpPort": 3389,
            "windowsDiskSize": 128,
            "sqlDiskSize": 128
        },
        "sqlAOEPName": "[concat(parameters('deploymentPrefix'),'-hadr')]",
        "sharePath": "[concat(parameters('deploymentPrefix'),'-fsw')]",
        "clusterName": "[concat(parameters('deploymentPrefix'),'-fc')]",
        "adPDCNicName": "[concat(variables('vmSettings').adPDCVMName,'-nic')]",
        "adBDCNicName": "[concat(variables('vmSettings').adBDCVMName,'-nic')]",
        "sqlwNicName": "[concat(variables('vmSettings').sqlwVMName,'-nic')]",
        "staticSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'),variables('subnetNames').staticSubnetName)]",
        "sqlSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'),variables('subnetNames').sqlSubnetName)]",
        "ids": {
            "adNicId": "[resourceId('Microsoft.Network/networkInterfaces',variables('adPDCNicName'))]",
            "rdplbID": "[resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').rdpLBName)]",
            "sqllbID": "[resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').sqlLBName)]"
        },
        "derivedIds": {
            "adIPConfigID": "[concat(variables('ids').adNicId,'/ipConfigurations/ipconfig1')]",
            "rdplbFEConfigID": "[concat(variables('ids').rdplbID,'/frontendIPConfigurations/',variables('lbSettings').rdpLBFE)]",
            "adRDPNATRuleID": "[concat(variables('ids').rdplbID,'/inboundNatRules/',variables('RDPNAT'))]",
            "adBEAddressPoolID": "[concat(variables('ids').rdplbID,'/backendAddressPools/',variables('lbSettings').adLBBE)]",
            "sqlBEAddressPoolID": "[concat(variables('ids').sqllbID,'/backendAddressPools/',variables('lbSettings').sqlLBBE)]",
            "sqllbFEConfigID": "[concat(variables('ids').sqllbID,'/frontendIPConfigurations/',variables('lbSettings').sqlLBFE)]",
            "sqllbProbeID": "[concat(variables('ids').sqllbID,'/probes/',variables('SQLAOProbe'))]"
        },
        "SQL2012SP2-WS2012R2": "Enterprise",
        "SQL2012SP3-WS2012R2": "Enterprise",
        "SQL2014-WS2012R2": "Enterprise",
        "SQL2014SP2-WS2012R2": "Enterprise",
        "SQL2016-WS2012R2": "Enterprise",
        "Monday": true,
        "Tuesday": true,
        "Wednesday": true,
        "Thursday": true,
        "Friday": true,
        "Saturday": true,
        "Sunday": true,
        "Never": false,
        "Everyday": true,
        "subnets": [
            {
                "name": "[variables('subnetNames').staticSubnetName]",
                "properties": {
                    "addressPrefix": "[parameters('staticSubnet')]"
                }
            },
            {
                "name": "[variables('subnetNames').sqlSubnetName]",
                "properties": {
                    "addressPrefix": "[parameters('sqlSubnet')]"
                }
            }
        ],
        "virtualNetworkNameWithSuffix": "[parameters('virtualNetworkName')]",
        "primaryDCIPAddressNameWithSuffix": "[variables('primaryDCIPAddressName')]",
        "backupDCIPAddressNameWithSuffix": "[variables('backupDCIPAddressName')]",
        "sql1AddressNameWithSuffix": "[variables('sql1AddressName')]",
        "sql0AddressNameWithSuffix": "[variables('sql0AddressName')]",
        "configuration": {
            "vnetwithDNSTemplateURL": "[concat(parameters('templatesBaseUrl'),'/vnet-with-dns-server.json')]",
            "nicTemplateURL": "[concat(parameters('templatesBaseUrl'),'/nic.json')]",
            "rdpIPAdressSetupURL": "[concat(parameters('templatesBaseUrl'),'/publicip-rdp.json')]",
            "vnetSetupURL": "[concat(parameters('templatesBaseUrl'),'/vnet-new.json')]",
            "setupLBsUrl": "[concat(parameters('templatesBaseUrl'),'/setupLBs.json')]",
            "creatingNicsUrl": "[concat(parameters('templatesBaseUrl'),'/creatingNICS.json')]",
            "storageAccountVirtualNetworkPublicIP": "[concat(parameters('templatesBaseUrl'),'/storageAccountVirtualNetworkPublicIP.json')]",
            "provisioningVMs": "[concat(parameters('templatesBaseUrl'),'/provisioningVM',parameters('numberOfSqlVMDisks'),'.json')]",
            "configuringBackupADVM": "[concat(parameters('templatesBaseUrl'),'/configuringBackupADVM.json')]",
            "preparingAlwaysOnSqlServer": "[concat(parameters('templatesBaseUrl'),'/preparingSqlServer.json')]",
            "configuringAlwaysOn": "[concat(parameters('templatesBaseUrl'),'/configuringAlwaysOn.json')]",
            "adPDCModulesURL": "[concat(parameters('scriptsBaseUrl'),'/CreateADPDC.ps1.zip')]",
            "adPDCConfigurationFunction": "CreateADPDC.ps1\\CreateADPDC",
            "adBDCModulesURL": "[concat(parameters('scriptsBaseUrl'),'/CreateADBDC.ps1.zip')]",
            "adBDCConfigurationFunction": "CreateADBDC.ps1\\CreateADBDC",
            "fswModulesURL": "[concat(parameters('scriptsBaseUrl'),'/CreateFileShareWitness.ps1.zip')]",
            "fswConfigurationFunction": "CreateFileShareWitness.ps1\\CreateFileShareWitness",
            "sqlAOPrepareModulesURL": "[concat(parameters('scriptsBaseUrl'),'/PrepareAlwaysOnSqlServer.ps1.zip')]",
            "sqlAOPrepareConfigurationFunction": "PrepareAlwaysOnSqlServer.ps1\\PrepareAlwaysOnSqlServer",
            "createClusterModulesURL": "[concat(parameters('scriptsBaseUrl'),'/CreateFailoverCluster.ps1.zip')]",
            "createClusterConfigurationFunction": "CreateFailoverCluster.ps1\\CreateFailoverCluster"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "name": "StorageAccountVirtualNetworkPublicIP",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').storageAccountVirtualNetworkPublicIP]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "sqlStorageAccountName": {
                        "value": "[parameters('sqlStorageAccountName')]"
                    },
                    "dcStorageAccountName": {
                        "value": "[parameters('dcStorageAccountName')]"
                    },
                    "SqlStorageAccountType": {
                        "value": "[parameters('sqlStorageAccountType')]"
                    },
                    "DcStorageAccountType": {
                        "value": "[parameters('dcStorageAccountType')]"
                    },
                    "primaryDCIPAddressNameWithSuffix": {
                        "value": "[variables('primaryDCIPAddressNameWithSuffix')]"
                    },
                    "backupDCIPAddressNameWithSuffix": {
                        "value": "[variables('backupDCIPAddressNameWithSuffix')]"
                    },
                    "sql1AddressNameWithSuffix": {
                        "value": "[variables('sql1AddressNameWithSuffix')]"
                    },
                    "sql0AddressNameWithSuffix": {
                        "value": "[variables('sql0AddressNameWithSuffix')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkNameWithSuffix')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "LoadBalancers",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').setupLBsUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "sqlLBName": {
                        "value": "[variables('lbSettings').sqlLBName]"
                    },
                    "sqlLBFE": {
                        "value": "[variables('lbSettings').sqlLBFE]"
                    },
                    "sqlLBIPAddress": {
                        "value": "[parameters('sqlLBIPAddress')]"
                    },
                    "staticSubnetRef": {
                        "value": "[variables('sqlSubnetRef')]"
                    },
                    "sqlLBBE": {
                        "value": "[variables('lbSettings').sqlLBBE]"
                    },
                    "sqlLBBEID": {
                        "value": "[variables('derivedIds').sqlBEAddressPoolID]"
                    },
                    "sqllbFEConfigID": {
                        "value": "[variables('derivedIds').sqllbFEConfigID]"
                    },
                    "sqllbProbeID": {
                        "value": "[variables('derivedIds').sqllbProbeID]"
                    },
                    "SQLAOProbe": {
                        "value": "[variables('SQLAOProbe')]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/StorageAccountVirtualNetworkPublicIP"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "CreatingNetworkInterfaces",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').creatingNicsUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adPDCNicName": {
                        "value": "[variables('adPDCNicName')]"
                    },
                    "adPDCNICIPAddress": {
                        "value": "[parameters('adPDCNICIPAddress')]"
                    },
                    "staticSubnetRef": {
                        "value": "[variables('staticSubnetRef')]"
                    },
                    "adBEAddressPoolID": {
                        "value": "[variables('derivedIds').adBEAddressPoolID]"
                    },
                    "adRDPNATRuleID": {
                        "value": "[variables('derivedIds').adRDPNATRuleID]"
                    },
                    "adBDCNicName": {
                        "value": "[variables('adBDCNicName')]"
                    },
                    "adBDCNICIPAddress": {
                        "value": "[parameters('adBDCNICIPAddress')]"
                    },
                    "sqlVMName": {
                        "value": "[variables('vmSettings').sqlVMName]"
                    },
                    "sqlSubnetRef": {
                        "value": "[variables('sqlSubnetRef')]"
                    },
                    "sqlBEAddressPoolID": {
                        "value": "[variables('derivedIds').sqlBEAddressPoolID]"
                    },
                    "sqlwNicName": {
                        "value": "[variables('sqlwNicName')]"
                    },
                    "primaryDCIPAddressNameWithSuffix": {
                        "value": "[variables('primaryDCIPAddressNameWithSuffix')]"
                    },
                    "backupDCIPAddressNameWithSuffix": {
                        "value": "[variables('backupDCIPAddressNameWithSuffix')]"
                    },
                    "sql1AddressNameWithSuffix": {
                        "value": "[variables('sql1AddressNameWithSuffix')]"
                    },
                    "sql0AddressNameWithSuffix": {
                        "value": "[variables('sql0AddressNameWithSuffix')]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/LoadBalancers"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "ProvisioningVMs",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').provisioningVMs]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adPDCVMName": {
                        "value": "[variables('vmSettings').adPDCVMName]"
                    },
                    "adAvailabilitySetName": {
                        "value": "[variables('vmSettings').availabilitySets.adAvailabilitySetName]"
                    },
                    "sqlAvailabilitySetName": {
                        "value": "[variables('vmSettings').availabilitySets.sqlAvailabilitySetName]"
                    },
                    "sqlStorageAccountName": {
                        "value": "[parameters('sqlStorageAccountName')]"
                    },
                    "dcStorageAccountName": {
                        "value": "[parameters('dcStorageAccountName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adVMSize": {
                        "value": "[parameters('adVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "adImagePublisher": {
                        "value": "[variables('vmSettings').windowsImagePublisher]"
                    },
                    "adImageOffer": {
                        "value": "[variables('vmSettings').windowsImageOffer]"
                    },
                    "adImageSKU": {
                        "value": "[variables('vmSettings').windowsImageSKU]"
                    },
                    "vmContainerName": {
                        "value": "[variables('vmSettings').vmContainerName]"
                    },
                    "adPDCNicName": {
                        "value": "[variables('adPDCNicName')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adPDCConfigurationFunction": {
                        "value": "[variables('configuration').adPDCConfigurationFunction]"
                    },
                    "adPDCModulesURL": {
                        "value": "[variables('configuration').adPDCModulesURL]"
                    },
                    "adBDCVMName": {
                        "value": "[variables('vmSettings').adBDCVMName]"
                    },
                    "adBDCNicName": {
                        "value": "[variables('adBDCNicName')]"
                    },
                    "sqlVMName": {
                        "value": "[variables('vmSettings').sqlVMName]"
                    },
                    "sqlVMSize": {
                        "value": "[parameters('sqlVMSize')]"
                    },
                    "fswImagePublisher": {
                        "value": "[variables('vmSettings').windowsImagePublisher]"
                    },
                    "fswImageOffer": {
                        "value": "[variables('vmSettings').windowsImageOffer]"
                    },
                    "fswImageSKU": {
                        "value": "[variables('vmSettings').windowsImageSKU]"
                    },
                    "sqlImagePublisher": {
                        "value": "[variables('vmSettings').sqlImagePublisher]"
                    },
                    "sqlImageOffer": {
                        "value": "[variables('vmSettings').sqlImageOffer]"
                    },
                    "sqlImageSKU": {
                        "value": "[variables(parameters('sqlServerVersion'))]"
                    },
                    "witnessVMSize": {
                        "value": "[parameters('witnessVMSize')]"
                    },
                    "sqlwVMName": {
                        "value": "[variables('vmSettings').sqlwVMName]"
                    },
                    "sqlwNicName": {
                        "value": "[variables('sqlwNicName')]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/CreatingNetworkInterfaces"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "UpdatingDNStoPrimaryADVM",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').vnetwithDNSTemplateURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkNameWithSuffix')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "DNSServerAddress": {
                        "value": [
                            "[parameters('adPDCNICIPAddress')]"
                        ]
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/ProvisioningVMs"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "ConfiguringBackupADVM",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').configuringBackupADVM]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adBDCVMName": {
                        "value": "[variables('vmSettings').adBDCVMName]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adBDCConfigurationFunction": {
                        "value": "[variables('configuration').adBDCConfigurationFunction]"
                    },
                    "adBDCModulesURL": {
                        "value": "[variables('configuration').adBDCModulesURL]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/ProvisioningVMs"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "UpdatingDNSwithBackupADVM",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').vnetwithDNSTemplateURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkNameWithSuffix')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "DNSServerAddress": {
                        "value": [
                            "[parameters('adPDCNICIPAddress')]",
                            "[parameters('adBDCNICIPAddress')]"
                        ]
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/ConfiguringBackupADVM"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "UpdatingSQLWNic",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').nicTemplateURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "nicName": {
                        "value": "[variables('sqlwNicName')]"
                    },
                    "ipConfigurations": {
                        "value": [
                            {
                                "name": "ipconfig1",
                                "properties": {
                                    "privateIPAllocationMethod": "Dynamic",
                                    "subnet": {
                                        "id": "[variables('sqlSubnetRef')]"
                                    }
                                }
                            }
                        ]
                    },
                    "dnsServers": {
                        "value": [
                            "[parameters('adPDCNICIPAddress')]",
                            "[parameters('adBDCNICIPAddress')]"
                        ]
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/UpdatingDNStoPrimaryADVM"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "UpdatingSQL0Nic",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').nicTemplateURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "nicName": {
                        "value": "[concat(variables('vmSettings').sqlVMName, '0-nic')]"
                    },
                    "ipConfigurations": {
                        "value": [
                            {
                                "name": "ipconfig1",
                                "properties": {
                                    "privateIPAllocationMethod": "Dynamic",
                                    "subnet": {
                                        "id": "[variables('sqlSubnetRef')]"
                                    },
                                    "publicIpAddress": {
                                        "id": "[resourceId(resourceGroup().Name,'Microsoft.Network/publicIpAddresses', variables('sql0AddressNameWithSuffix'))]"
                                    },
                                    "loadBalancerBackendAddressPools": [
                                        {
                                            "id": "[variables('derivedIds').sqlBEAddressPoolID]"
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "dnsServers": {
                        "value": [
                            "[parameters('adPDCNICIPAddress')]",
                            "[parameters('adBDCNICIPAddress')]"
                        ]
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/UpdatingSQLWNic"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "UpdatingSQL1Nic",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').nicTemplateURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "nicName": {
                        "value": "[concat(variables('vmSettings').sqlVMName, '1-nic')]"
                    },
                    "ipConfigurations": {
                        "value": [
                            {
                                "name": "ipconfig1",
                                "properties": {
                                    "privateIPAllocationMethod": "Dynamic",
                                    "subnet": {
                                        "id": "[variables('sqlSubnetRef')]"
                                    },
                                    "publicIpAddress": {
                                        "id": "[resourceId(resourceGroup().Name,'Microsoft.Network/publicIpAddresses', variables('sql1AddressNameWithSuffix'))]"
                                    },
                                    "loadBalancerBackendAddressPools": [
                                        {
                                            "id": "[variables('derivedIds').sqlBEAddressPoolID]"
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "dnsServers": {
                        "value": [
                            "[parameters('adPDCNICIPAddress')]",
                            "[parameters('adBDCNICIPAddress')]"
                        ]
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/UpdatingSQL0Nic"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "PreparingAlwaysOnSqlServer",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').preparingAlwaysOnSqlServer]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlVMName": {
                        "value": "[variables('vmSettings').sqlVMName]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "sqlAOPrepareModulesURL": {
                        "value": "[variables('configuration').sqlAOPrepareModulesURL]"
                    },
                    "sqlAOPrepareConfigurationFunction": {
                        "value": "[variables('configuration').sqlAOPrepareConfigurationFunction]"
                    },
                    "sqlAOEPName": {
                        "value": "[variables('sqlAOEPName')]"
                    },
                    "sqlServerServiceAccountUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "sqlServerServiceAccountPassword": {
                        "value": "[parameters('sqlServerServiceAccountPassword')]"
                    },
                    "sharePath": {
                        "value": "[variables('sharePath')]"
                    },
                    "adPDCVMName": {
                        "value": "[variables('vmSettings').adPDCVMName]"
                    },
                    "sqlwVMName": {
                        "value": "[variables('vmSettings').sqlwVMName]"
                    },
                    "fswModulesURL": {
                        "value": "[variables('configuration').fswModulesURL]"
                    },
                    "fswConfigurationFunction": {
                        "value": "[variables('configuration').fswConfigurationFunction]"
                    },
                    "autoPatchingDay": {
                        "value": "[parameters('autoPatchingDay')]"
                    },
                    "autoPatchingStartHour": {
                        "value": "[parameters('autoPatchingStartHour')]"
                    },
                    "autoPatchingEnable": {
                        "value": "[variables(parameters('autoPatchingDay'))]"
                    },
                    "numberOfDisks": {
                        "value": "[parameters('numberOfSqlVMDisks')]"
                    },
                    "workloadType": {
                        "value": "[parameters('workloadType')]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/UpdatingSQL0Nic"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "ConfiguringAlwaysOn",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuration').configuringAlwaysOn]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlVMName": {
                        "value": "[variables('vmSettings').sqlVMName]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "sqlAOEPName": {
                        "value": "[variables('sqlAOEPName')]"
                    },
                    "sqlServerServiceAccountUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "sqlServerServiceAccountPassword": {
                        "value": "[parameters('sqlServerServiceAccountPassword')]"
                    },
                    "createClusterModulesURL": {
                        "value": "[variables('configuration').createClusterModulesURL]"
                    },
                    "createClusterConfigurationFunction": {
                        "value": "[variables('configuration').createClusterConfigurationFunction]"
                    },
                    "clusterName": {
                        "value": "[variables('clusterName')]"
                    },
                    "sharePath": {
                        "value": "[variables('sharePath')]"
                    },
                    "sqlAOAGName": {
                        "value": "[parameters('sqlAOAGName')]"
                    },
                    "sqlAOListenerName": {
                        "value": "[parameters('sqlAOListenerName')]"
                    },
                    "sqlAOListenerPort": {
                        "value": "[parameters('sqlAOListenerPort')]"
                    },
                    "sqlLBName": {
                        "value": "[variables('lbSettings').sqlLBName]"
                    },
                    "sqlLBIPAddress": {
                        "value": "[parameters('sqlLBIPAddress')]"
                    },
                    "adPDCVMName": {
                        "value": "[variables('vmSettings').adPDCVMName]"
                    },
                    "sqlwVMName": {
                        "value": "[variables('vmSettings').sqlwVMName]"
                    },
                    "numberOfDisks": {
                        "value": "[parameters('numberOfSqlVMDisks')]"
                    },
                    "workloadType": {
                        "value": "[parameters('workloadType')]"
                    }
                }
            },
            "dependsOn": [
                "Microsoft.Resources/deployments/PreparingAlwaysOnSqlServer"
            ]
        }
    ],
    "outputs": {}
}